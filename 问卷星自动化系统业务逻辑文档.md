# 问卷星自动化系统业务逻辑文档

## 1. 系统概述

问卷星自动化系统是一个用于自动填写和提交问卷星问卷的工具，主要面向需要批量完成问卷的用户。系统通过解析问卷结构、自动生成答案并模拟人类行为提交问卷，提高填写效率的同时确保数据质量和真实性。

### 1.1 系统目标

- **自动解析问卷**：从问卷URL获取问卷结构和题目内容
- **智能生成答案**：基于问卷内容生成合理的答案
- **批量提交问卷**：支持单次创建多个问卷提交任务
- **模拟人类行为**：通过随机时间间隔和答案模拟真实人类填写行为
- **任务管理与监控**：提供任务创建、暂停、恢复和状态监控功能
- **提供Web API接口**：支持通过HTTP接口调用系统功能

### 1.2 核心功能

1. 问卷解析 - 从问卷星URL解析问卷结构和题目
2. 答案生成 - 基于问卷内容自动生成答案
3. 批量提交 - 批量创建和执行问卷提交任务
4. 任务管理 - 创建、查询、暂停、恢复和删除任务
5. 人类行为模拟 - 随机时间间隔和答案选择模拟真实用户
6. 大语言模型集成 - 使用LLM生成更智能的问卷答案

## 2. 业务流程

### 2.1 问卷填写流程

```
┌─────────────┐    ┌───────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  问卷URL解析 │ -> │  问卷结构提取  │ -> │ 问卷答案生成 │ -> │ 问卷数据提交 │ -> │ 结果记录统计 │
└─────────────┘    └───────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

#### 详细流程说明：

1. **问卷URL解析**：
   - 接收问卷星URL（如 https://www.wjx.cn/vm/xxxx.aspx）
   - 提取问卷ID和访问参数
   - 验证URL有效性

2. **问卷结构提取**：
   - 访问问卷页面获取HTML内容
   - 解析HTML提取问卷标题、描述
   - 提取所有问题及选项
   - 识别不同类型的问题（单选、多选、填空、矩阵、评分等）

3. **问卷答案生成**：
   - 根据题目类型生成合适的随机答案
   - 支持使用大语言模型生成更智能的答案
   - 应用答案概率分布确保答案多样性
   - 遵循问卷逻辑关系（如跳题逻辑）

4. **问卷数据提交**：
   - 构建提交参数（jqnonce, ktimes, starttime等）
   - 加密提交数据
   - 发送HTTP请求提交答案
   - 处理提交响应和错误

5. **结果记录统计**：
   - 记录提交结果（成功/失败）
   - 更新任务状态和进度
   - 记录IP使用情况（如使用代理）
   - 生成任务执行报告

### 2.2 任务管理流程

```
┌─────────────┐    ┌───────────────┐    ┌─────────────────┐    ┌─────────────┐
│  创建任务   │ -> │  任务调度执行  │ -> │ 任务监控与控制  │ -> │ 任务完成处理 │
└─────────────┘    └───────────────┘    └─────────────────┘    └─────────────┘
```

#### 详细流程说明：

1. **创建任务**：
   - 接收任务参数（问卷ID、数量、是否使用LLM等）
   - 验证参数有效性
   - 生成任务ID和初始化任务状态
   - 保存任务信息

2. **任务调度执行**：
   - 创建后台线程执行任务
   - 根据问卷复杂度和任务参数调整执行策略
   - 控制任务执行频率和并发数

3. **任务监控与控制**：
   - 实时更新任务进度和状态
   - 支持暂停、恢复和停止任务
   - 记录任务执行日志
   - 处理执行异常和错误恢复

4. **任务完成处理**：
   - 更新最终任务状态
   - 生成任务执行报告
   - 统计成功率和执行时间
   - 清理临时资源

## 3. 关键业务算法

### 3.1 问卷解析算法

问卷解析是系统的基础功能，通过HTML解析从问卷页面提取问卷结构和题目内容：

1. **网页获取**：使用requests库获取问卷页面HTML内容
2. **DOM解析**：使用BeautifulSoup解析HTML DOM结构
3. **问题提取**：根据DOM选择器定位问题元素，提取题目和选项
4. **问题分类**：根据HTML元素属性和结构识别不同类型的问题
5. **数据结构化**：将提取的问卷信息转换为标准化的JSON格式

### 3.2 答案生成算法

系统支持两种答案生成方式：随机生成和LLM智能生成：

#### 3.2.1 随机答案生成

1. **类型匹配**：根据问题类型选择相应的答案生成策略
   - 单选题：随机选择一个选项，可设置选项权重
   - 多选题：随机选择1-N个选项，支持控制选择数量分布
   - 填空题：从预设答案库中选择或生成随机文本
   - 量表题：生成符合正态分布的评分
   - 矩阵题：为每行生成随机答案
   - 排序题：生成随机排序

2. **逻辑关系处理**：处理题目间的逻辑关系，如条件显示和跳题逻辑

3. **答案格式化**：将生成的答案转换为问卷星提交格式（如：`1$2}2$3|4|5}3$文本内容`）

#### 3.2.2 LLM智能答案生成

1. **提示词构建**：根据问卷内容构建结构化的LLM提示词
2. **API调用**：调用LLM API（支持阿里云、智谱、百度、OpenAI等）
3. **结果解析**：解析LLM返回的JSON格式答案
4. **答案验证**：验证答案格式和内容的有效性
5. **格式转换**：将LLM生成的答案转换为问卷星提交格式

### 3.3 人类行为模拟算法

系统通过多种技术模拟真实人类填写问卷的行为：

1. **时间间隔模拟**：根据问卷复杂度生成符合人类行为的随机时间间隔
   - 考虑问题数量和类型的复杂度
   - 考虑时间段因素（如工作时间vs夜间）
   - 添加随机中断和思考时间

2. **提交参数计算**：
   - `starttime`: 生成合理的开始时间，避免填写时间过短
   - `ktimes`: 根据问题数量计算的动态参数
   - `jqnonce` 和 `jqsign`: 从页面提取并计算的验证参数

3. **答案分布控制**：
   - 保持随机性但符合统计规律
   - 避免极端选择模式
   - 考虑选项的相对权重

### 3.4 数据加密算法

问卷星提交需要特定的数据加密：

```python
def dataenc(s, ktimes):
    """数据加密函数"""
    t = ktimes % 10
    t = t or 1  # 如果 t=0 则设为1
    return ''.join([chr(ord(c) ^ t) for c in s])
```

## 4. 特殊业务规则

### 4.1 提交频率控制

为避免被问卷星系统检测为自动提交，系统实现了智能频率控制：

1. **动态延迟计算**：
   ```python
   def _generate_human_like_delay(current_task_num, total_tasks, survey_complexity):
       # 基础延迟设置
       base_delay_min = 3.0  # 最小基础延迟秒数
       base_delay_max = 8.0  # 最大基础延迟秒数
       
       # 根据问卷复杂度和进度调整延迟
       progress_ratio = current_task_num / total_tasks
       complexity_factor = min(1.5, max(0.8, survey_complexity / 5.0))
       
       # 计算当前阶段合适的延迟
       # 开始阶段略慢，中间快，结束前再次放慢
       if progress_ratio < 0.2:
           # 开始阶段
           stage_factor = 1.1
       elif progress_ratio > 0.8:
           # 结束阶段
           stage_factor = 1.2
       else:
           # 中间阶段
           stage_factor = 0.9
       
       # 考虑时间因素
       current_hour = datetime.now().hour
       if 0 <= current_hour < 6:
           # 凌晨时段，速度放慢
           time_factor = 1.4
       elif 22 <= current_hour < 24:
           # 深夜时段，速度中等偏慢
           time_factor = 1.2
       elif 9 <= current_hour < 12 or 14 <= current_hour < 18:
           # 工作高峰期，速度偏快
           time_factor = 0.85
       else:
           # 其他时段，正常速度
           time_factor = 1.0
       
       # 综合各因素计算延迟
       adjusted_min = base_delay_min * complexity_factor * stage_factor * time_factor
       adjusted_max = base_delay_max * complexity_factor * stage_factor * time_factor
       
       delay = random.uniform(adjusted_min, adjusted_max)
       
       # 随机添加一些短暂"思考"暂停
       if random.random() < 0.15:  # 15%的概率添加思考时间
           delay += random.uniform(1.5, 4.0)
           logger.debug("添加额外思考时间，总延迟: %.2f秒", delay)
       
       # 随机增加批次提交等待时间
       if current_task_num > 1 and current_task_num % 5 == 0:
           # 每5个任务后增加一个较长的间隔
           batch_wait = random.uniform(5.0, 12.0)
           delay += batch_wait
           logger.debug(f"批次提交等待，增加 {batch_wait:.2f} 秒")
       
       logger.debug(f"任务 {current_task_num}/{total_tasks}，复杂度: {survey_complexity}，生成延迟: {delay:.2f}秒")
       return delay
   ```

2. **IP轮换机制**：支持使用代理IP，定期更换提交IP地址
3. **批次控制**：将大量提交任务分批执行，避免短时间内大量提交

### 4.2 任务状态管理

任务在生命周期中可能处于以下状态：

1. **pending**：任务已创建但尚未开始执行
2. **running**：任务正在执行中
3. **paused**：任务已暂停，可以恢复
4. **stopped**：任务已手动停止，不可恢复
5. **completed**：任务已成功完成
6. **failed**：任务执行失败

状态转换规则：
- pending -> running：任务开始执行
- running -> paused：用户暂停任务
- paused -> running：用户恢复任务
- running/paused -> stopped：用户停止任务
- running -> completed：所有提交任务成功完成
- running -> failed：任务执行过程中遇到致命错误

## 5. 业务优化策略

### 5.1 提高成功率的策略

1. **参数动态调整**：根据提交结果动态调整提交参数
2. **错误自动重试**：检测到临时性错误时自动重试提交
3. **智能验证码处理**：当检测到验证码时，采取相应的处理策略
4. **答案质量控制**：确保生成的答案符合问卷逻辑和要求

### 5.2 性能优化策略

1. **并发任务控制**：控制并发任务数量，避免系统资源过载
2. **任务优先级管理**：支持设置任务优先级，优先执行高优先级任务
3. **资源自动释放**：完成或失败的任务自动释放占用的资源
4. **结果数据缓存**：缓存常用问卷和任务数据，减少重复解析

### 5.3 安全性策略

1. **IP轮换和保护**：智能管理IP资源，避免单个IP被封禁
2. **参数随机化**：提交参数随机化，避免固定模式被检测
3. **访问频率控制**：控制访问频率，模拟真实用户行为
4. **错误隔离**：单个任务的错误不影响其他任务执行

## 6. 实现难点与解决方案

### 6.1 问卷解析难点

**难点**: 问卷星网页结构复杂且可能变化，不同类型问题的DOM结构差异较大。

**解决方案**:
- 使用多级CSS选择器匹配问题元素
- 实现降级匹配策略，当主选择器失效时尝试备用选择器
- 针对不同类型问题实现专门的解析逻辑
- 定期更新解析规则以适应问卷星网站变化

### 6.2 提交参数计算难点

**难点**: 问卷星提交需要特定的加密参数，包括jqnonce、ktimes和加密签名。

**解决方案**:
- 从页面提取jqnonce参数
- 根据问题数量动态计算ktimes参数
- 实现与问卷星相同的签名加密算法
- 模拟合理的starttime参数

### 6.3 人类行为模拟难点

**难点**: 自动化提交容易被问卷星反作弊系统检测。

**解决方案**:
- 实现复杂的时间间隔生成算法
- 答案选择遵循合理的统计分布
- 提交过程加入随机中断和思考时间
- 考虑填写时间段的影响因素

### 6.4 大规模并发处理难点

**难点**: 大量并发任务可能导致系统资源不足或被目标网站封禁。

**解决方案**:
- 实现任务队列和调度机制
- 控制单位时间内的请求频率
- 引入IP池和代理机制
- 实现任务批次处理和动态调整

## 7. 结语

问卷星自动化系统通过精心设计的业务流程和算法，实现了问卷的高效自动填写和提交。系统在保证提交成功率的同时，通过多种技术手段模拟人类行为，提高了自动化程度和安全性。系统的模块化设计和可扩展架构，也为未来功能扩展和优化提供了良好基础。 